name: Showcase - Node.js Dependency Audit

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        type: string
        default: 'opus'
      timeout_minutes:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 45
      base_branch:
        description: 'Base branch for PRs'
        required: false
        type: string
        default: 'main'
      node_version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      lint_command:
        description: 'Lint command to verify changes'
        required: false
        type: string
        default: 'npm run lint'
      test_command:
        description: 'Test command to verify changes'
        required: false
        type: string
        default: 'npm test'
      custom_prompt:
        description: 'Custom audit prompt (optional)'
        required: false
        type: string
        default: ''
    secrets:
      ANTHROPIC_API_KEY:
        required: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated dependencies
        id: check-outdated
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated --json > /tmp/outdated.json 2>/dev/null || true

          if [ ! -s /tmp/outdated.json ] || [ "$(cat /tmp/outdated.json)" = "{}" ]; then
            echo "has_outdated=false" >> $GITHUB_OUTPUT
            echo "No outdated dependencies found"
          else
            echo "has_outdated=true" >> $GITHUB_OUTPUT
            echo "Found outdated dependencies"
            cat /tmp/outdated.json
          fi

      - name: Run security audit
        id: security-audit
        run: |
          echo "Running security audit..."
          npm audit --json > /tmp/audit.json 2>/dev/null || true

          if [ -s /tmp/audit.json ]; then
            VULNERABILITIES=$(cat /tmp/audit.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('metadata',{}).get('vulnerabilities',{}).get('total',0))" 2>/dev/null || echo "0")
            echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
            echo "Found $VULNERABILITIES vulnerabilities"
          else
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Claude Dependency Analysis & Update
        if: steps.check-outdated.outputs.has_outdated == 'true' || steps.security-audit.outputs.vulnerabilities != '0'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: ${{ inputs.model }}
          timeout_minutes: ${{ inputs.timeout_minutes }}
          base_branch: ${{ inputs.base_branch }}
          branch_prefix: claude/deps-update-
          max_turns: 40
          allowed_tools: "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh:*),Bash(npm:*)"
          direct_prompt: |
            ${{ inputs.custom_prompt != '' && inputs.custom_prompt || format('
            # Dependency Audit

            You are running a dependency audit.

            ## Your Tasks

            1. **Analyze outdated packages**: Run `npm outdated` and review results

            2. **Analyze security vulnerabilities**: Run `npm audit` and review results

            3. **Update packages safely**:
               - Use `npm update package-name` for minor/patch updates
               - For major versions, use `npm install package-name@latest` only if safe
               - Run `npm audit fix` for security fixes

            4. **Verify updates**:
               - Run `{0}` to check for lint issues
               - Run `{1}` to verify tests pass
               - If anything fails, revert that specific update

            5. **Create PR** if any updates were made:
               - Create branch from {2}
               - Commit package.json and package-lock.json changes
               - PR title: "chore(deps): update dependencies"
               - PR body should list:
                 - Each package updated with old to new version
                 - Security vulnerabilities fixed (if any)

            ## Guidelines
            - Be CONSERVATIVE - when in doubt, do not update
            - If tests fail after an update, revert that update
            - Group related updates together
            - If NO updates are possible, report that and do not create a PR
            ', inputs.lint_command, inputs.test_command, inputs.base_branch) }}

      - name: Report no updates needed
        if: steps.check-outdated.outputs.has_outdated == 'false' && steps.security-audit.outputs.vulnerabilities == '0'
        run: |
          echo "All dependencies are up to date and no security vulnerabilities found."
          echo "No action needed."
