name: Reusable - Claude PR Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        type: string
        default: 'opus'
      timeout_minutes:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 30
      review_prompt:
        description: 'Custom review prompt (optional, uses default if not provided)'
        required: false
        type: string
        default: ''
    secrets:
      ANTHROPIC_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  review:
    # Run on PR events, or on issue comments that mention @claude
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (PR event)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Checkout repository (issue_comment event)
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch (issue_comment event)
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr checkout ${{ github.event.issue.number }}

      - name: Get PR base branch
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          else
            BASE_REF=$(gh pr view ${{ github.event.issue.number }} --json baseRefName -q '.baseRefName')
            echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          fi

      - name: Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: ${{ inputs.model }}
          timeout_minutes: ${{ inputs.timeout_minutes }}
          track_progress: true
          prompt: |
            ${{ inputs.review_prompt != '' && inputs.review_prompt || format('
            Review this Pull Request thoroughly.

            1. Run `git diff origin/{0}...HEAD` to see all changes
            2. Analyze the code for:
               - Correctness and potential bugs
               - TypeScript type safety (no `any` types)
               - Error handling
               - Security issues
               - Performance concerns
               - Code style and readability
            3. If a .claude/agents/code-reviewer.md exists, use it as the review checklist
            4. Provide feedback organized by severity (Critical, Warning, Suggestion)
            ', steps.pr-info.outputs.base_ref) }}
          claude_args: |
            --max-turns 10
            --allowedTools "Read,Glob,Grep,Bash(git:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
